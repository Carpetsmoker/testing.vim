#!/bin/sh

set -euC
testingdir=$(cd -P "$(dirname "$0")" >/dev/null && pwd)

. "$testingdir/shared"

if [ -z "${1:-}" ]; then
	>&2 echo "Must give at least one test file"
	exit 1
fi

if [ $(link_pack "$@") -gt 0 ]; then
	>&2 echo "could not locate the plugin directory for $files"
	exit 2
fi

packdir="$tmpdir/pack/t/start/$(ls "$tmpdir/pack/t/start")"
for f in "$@"; do
	${TEST_VIM:-vim} --noplugin -u NONE -N -e \
		+"set shm+=WAFI rtp^=$packdir packpath=$tmpdir" \
		+'filetype plugin indent on' \
		+'packloadall!' \
		+"silent e $f" \
		+"let g:test_tmpdir='$tmpdir'" \
		-S "$testingdir/syntax.vim" \
		-S "$testingdir/syntaxtest.vim" >/dev/null </dev/null || (
			echo  'TEST RUNNER FAILURE; error in syntaxtest.vim'
			exit 5
		)
done

printf '" This file is automatically generated by test-syntax from testing.vim'

cat "$tmpdir/syntax.tmp"
